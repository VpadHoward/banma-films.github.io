<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å | BANMA FILMS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">BANMA FILMS</div>
        <nav>
            <a href="index.html">–°–µ—Ä–∏–∏</a>
            <a href="wiki.html">Wiki</a>
            <a href="profile.html" class="active" onclick="resetProfileView()">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </nav>
    </header>

    <main class="container profile-container" style="margin-top: 120px;">
        <div id="auth-forms" style="max-width: 400px; margin: 0 auto;">
            <div class="section-header"><h2>–í–•–û–î</h2></div>
            <div class="comment-form">
                <input type="text" id="auth-login" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                <div style="display:flex; gap:10px;">
                    <button onclick="handleAuth('login')" style="flex:1;">–í–æ–π—Ç–∏</button>
                    <button onclick="handleAuth('reg')" style="flex:1; background:none; border:1px solid var(--accent);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
            </div>
        </div>

        <div id="user-profile" style="display:none;">
            <div class="profile-grid">
                <aside class="profile-card">
                    <div class="avatar-upload">
                        <img id="profile-avatar-preview" src="https://via.placeholder.com/150">
                        <input type="file" id="avatar-input" accept="image/*" onchange="uploadAvatar()">
                        <label for="avatar-input" id="avatar-label">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                    </div>
                    <h2 id="user-name-display" style="color: var(--gold); margin: 20px 0;"></h2>
                    
                    <div class="achievements-section">
                        <div id="ach-detective" class="achievement locked">
                            <div class="ach-icon">üïµÔ∏è</div>
                            <div class="ach-info"><strong>–î–µ—Ç–µ–∫—Ç–∏–≤</strong><span>–í—Å–µ –ø–∞—Å—Ö–∞–ª–∫–∏ –Ω–∞–π–¥–µ–Ω—ã</span></div>
                        </div>
                    </div>

                    <div id="owner-controls">
                        <button onclick="logout()" style="background:#ff4444; width:100%; margin-top:20px; border-radius:8px; padding:10px; color:white; border:none; font-weight:bold;">–í—ã–π—Ç–∏</button>
                    </div>
                    <div id="guest-controls" style="display:none;">
                        <button onclick="resetProfileView()" style="background:var(--accent); width:100%; margin-top:20px; border-radius:8px; padding:10px; color:white; border:none; font-weight:bold;">–í —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>
                </aside>

                <section class="wall-section">
                    <h3 style="margin-bottom: 20px; color: var(--gold);">–°—Ç–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    
                    <div class="comment-form" id="wall-form">
                        <textarea id="wall-text" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ —Å—Ç–µ–Ω–µ..."></textarea>
                        <button onclick="saveWallComment()">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                    </div>
                    <div id="wall-auth-msg" style="display:none; text-align:center; padding:10px; color:var(--text-gray);">
                        –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –Ω–∞ —Å—Ç–µ–Ω–∞—Ö.
                    </div>

                    <div id="wall-comments-list" style="margin-top: 30px;"></div>
                </section>
            </div>
        </div>
    </main>

    <script src="auth-logic.js"></script>
    <script>
        let profileOwnerLogin = null;

        function updateUI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const targetUserName = localStorage.getItem('view_target_user');
            const allUsers = JSON.parse(localStorage.getItem('banma_users')) || [];
            
            let displayUser = currentUser;
            let isOwner = true;

            if (targetUserName && (!currentUser || targetUserName !== currentUser.login)) {
                const found = allUsers.find(u => u.login === targetUserName);
                if (found) {
                    displayUser = found;
                    isOwner = false;
                }
            }

            if (displayUser) {
                profileOwnerLogin = displayUser.login;
                
                document.getElementById('auth-forms').style.display = "none";
                document.getElementById('user-profile').style.display = "block";
                
                document.getElementById('user-name-display').innerText = displayUser.login;
                document.getElementById('profile-avatar-preview').src = displayUser.avatar || 'https://via.placeholder.com/150';

                const foundEggs = JSON.parse(localStorage.getItem('found_eggs_' + displayUser.login)) || [];
                document.getElementById('ach-detective').className = foundEggs.length >= 5 ? 'achievement unlocked' : 'achievement locked';

                if (isOwner) {
                    document.getElementById('owner-controls').style.display = 'block';
                    document.getElementById('guest-controls').style.display = 'none';
                    document.getElementById('avatar-label').style.display = 'block';
                } else {
                    document.getElementById('owner-controls').style.display = 'none';
                    document.getElementById('guest-controls').style.display = 'block';
                    document.getElementById('avatar-label').style.display = 'none';
                }

                if(!currentUser) {
                    document.getElementById('wall-form').style.display = 'none';
                    document.getElementById('wall-auth-msg').style.display = 'block';
                } else {
                    document.getElementById('wall-form').style.display = 'flex';
                    document.getElementById('wall-auth-msg').style.display = 'none';
                }

                loadWallComments(displayUser.login);

            } else {
                document.getElementById('auth-forms').style.display = "block";
                document.getElementById('user-profile').style.display = "none";
            }
        }

        function loadWallComments(login) {
            const allWalls = JSON.parse(localStorage.getItem('banma_wall_data')) || {};
            const comments = allWalls[login] || [];
            const list = document.getElementById('wall-comments-list');
            
            list.innerHTML = comments.length ? comments.map(c => `
                <div class="wall-msg">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="color:var(--gold); cursor:pointer;" onclick="viewUser('${c.from}')">${c.from}</strong>
                        <small style="opacity:0.4; font-size:0.7rem;">${c.date}</small>
                    </div>
                    <p style="font-size:0.9rem; line-height:1.4;">${c.text}</p>
                </div>
            `).join('') : '<p style="text-align:center; opacity:0.3;">–ó–¥–µ—Å—å –ø–æ–∫–∞ —Ç–∏—à–∏–Ω–∞...</p>';
        }

        function saveWallComment() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const text = document.getElementById('wall-text').value.trim();
            if (!text || !currentUser) return;

            const allWalls = JSON.parse(localStorage.getItem('banma_wall_data')) || {};
            
            if (!allWalls[profileOwnerLogin]) allWalls[profileOwnerLogin] = [];

            allWalls[profileOwnerLogin].unshift({
                from: currentUser.login,
                text: text,
                date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString().slice(0,5)
            });

            localStorage.setItem('banma_wall_data', JSON.stringify(allWalls));
            document.getElementById('wall-text').value = '';
            loadWallComments(profileOwnerLogin);
        }

        function resetProfileView() {
            localStorage.removeItem('view_target_user');
            window.location.href = 'profile.html';
        }

        function logout() { localStorage.removeItem('currentUser'); location.reload(); }
        
        function uploadAvatar() {
            const input = document.getElementById('avatar-input');
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function() {
                const base64 = reader.result;
                let user = JSON.parse(localStorage.getItem('currentUser'));
                user.avatar = base64;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                let users = JSON.parse(localStorage.getItem('banma_users'));
                let idx = users.findIndex(u => u.login === user.login);
                if (idx !== -1) {
                    users[idx].avatar = base64;
                    localStorage.setItem('banma_users', JSON.stringify(users));
                }
                document.getElementById('profile-avatar-preview').src = base64;
            }
            reader.readAsDataURL(input.files[0]);
        }

        window.onload = updateUI;
    </script>
</body>
</html>
